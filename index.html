import React, { useEffect, useState, useRef } from "react";

const SHEET_ID = "1yHdj1almgPF4q_pPpSx7qZjfC1LoA6UChjit60_khfg";
const SHEET_NAME = "Mp";
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
const REFRESH_INTERVAL_MS = 3000;
const UNIT_DIVISOR = 7000;

function splitLines(text) {
  if (!text) return [];
  return text.replace(/
/g, "
").replace(//g, "
").split("
");
}

function parseCSVLine(line) {
  const result = [];
  let cur = "";
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      if (inQuotes && line[i + 1] === '"') {
        cur += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (ch === ',' && !inQuotes) {
      result.push(cur);
      cur = "";
    } else {
      cur += ch;
    }
  }
  result.push(cur);
  return result;
}

function parseCSV(csvText) {
  if (!csvText) return [];
  if (csvText.charCodeAt(0) === 0xfeff) csvText = csvText.slice(1);
  const lines = splitLines(csvText).filter((l) => l.trim() !== "");
  if (lines.length === 0) return [];
  const headers = parseCSVLine(lines[0]).map((h) => (h || "").trim());
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const values = parseCSVLine(lines[i]);
    if (values.length === 0) continue;
    const obj = {};
    for (let j = 0; j < headers.length; j++) {
      const key = headers[j] || `col_${j}`;
      obj[key] = values[j] !== undefined ? values[j].trim() : "";
    }
    rows.push(obj);
  }
  return rows;
}

function firstMatchingValue(row, candidates) {
  for (const k of Object.keys(row)) {
    const lk = k.toLowerCase();
    for (const c of candidates) {
      if (lk === c.toLowerCase() || lk.includes(c.toLowerCase())) return row[k];
    }
  }
  return "";
}

function formatNumber(n) {
  if (typeof n !== 'number' || !isFinite(n)) return '0';
  return n.toLocaleString();
}

export default function Telethon2025Dashboard() {
  const [view, setView] = useState("Asatiza");
  const [rows, setRows] = useState([]);
  const [lastUpdated, setLastUpdated] = useState(null);
  const refreshRef = useRef(null);

  async function fetchData() {
    try {
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Fetch failed: " + res.status);
      const text = await res.text();
      const parsed = parseCSV(text);
      const normalized = parsed.map((r) => {
        const out = { ...r };
        out._amount = 0;
        for (const key of Object.keys(r)) {
          const lk = key.toLowerCase();
          if (lk.includes("amount") || lk.includes("total") || lk.includes("raqam")) {
            const raw = (r[key] || "").toString();
            const num = parseFloat(raw.replace(/[^0-9.-]+/g, ""));
            if (!isNaN(num)) out._amount = num;
          }
        }
        return out;
      });
      setRows(normalized);
      setLastUpdated(new Date());
    } catch (e) {
      console.error(e);
    }
  }

  useEffect(() => {
    fetchData();
    refreshRef.current = setInterval(() => fetchData(), REFRESH_INTERVAL_MS);
    return () => {
      if (refreshRef.current) clearInterval(refreshRef.current);
    };
  }, []);

  const asatizaData = rows.map((r, idx) => {
    const rankRaw = firstMatchingValue(r, ["rank", "rnk"]) || "";
    const rankNum = parseInt((rankRaw + "").replace(/[^0-9]+/g, ""), 10);
    const rank = Number.isFinite(rankNum) && rankNum > 0 ? rankNum : null;
    const jamia = firstMatchingValue(r, ["jamia", "institute", "institution", "madarsa"]) || "";
    const ustaz = firstMatchingValue(r, ["ustaz", "ustad", "teacher", "name"]) || "";
    const raqamRaw = firstMatchingValue(r, ["raqam", "amount", "total"]) || "";
    const raqam = parseFloat((raqamRaw + "").replace(/[^0-9.-]+/g, "")) || 0;
    const unit = Number.isFinite(raqam) ? raqam / UNIT_DIVISOR : 0;
    return { id: `a-${idx}`, rank, jamia, ustaz, raqam, unit };
  });

  const jamiaGroups = {};
  rows.forEach((r) => {
    let jamiaName = firstMatchingValue(r, ["jamia", "institute", "institution", "madarsa"]) || "";
    if (!jamiaName) {
      const firstKey = Object.keys(r)[0] || "";
      jamiaName = (r[firstKey] || "") + "";
    }
    jamiaName = (jamiaName || "Unknown").trim();
    const amount = r._amount !== undefined ? Number(r._amount) : 0;
    if (!jamiaGroups[jamiaName]) jamiaGroups[jamiaName] = { jamia: jamiaName, totalAmount: 0, count: 0 };
    jamiaGroups[jamiaName].totalAmount += isNaN(amount) ? 0 : amount;
    jamiaGroups[jamiaName].count += 1;
  });

  const jamiaData = Object.values(jamiaGroups).map((g, i) => ({ id: `j-${i}`, ...g, totalUnit: g.totalAmount / UNIT_DIVISOR }));
  jamiaData.sort((a, b) => b.totalAmount - a.totalAmount);

  const sortedByAmount = [...asatizaData].sort((a, b) => b.raqam - a.raqam);
  const topAsatizaByAmount = sortedByAmount.slice(0, 3).map((x) => x.id);

  function getAsatizaPosition(id) {
    const byRank = asatizaData.filter((x) => x.rank !== null).sort((a, b) => a.rank - b.rank).map((x) => x.id);
    if (byRank.length >= 3) {
      const pos = byRank.indexOf(id);
      return pos >= 0 ? pos : null;
    }
    const posAmount = topAsatizaByAmount.indexOf(id);
    return posAmount >= 0 ? posAmount : null;
  }

  function topClass(pos) {
    if (pos === 0) return "bg-amber-50 border-amber-300";
    if (pos === 1) return "bg-slate-50 border-slate-300";
    if (pos === 2) return "bg-lime-50 border-lime-300";
    return "";
  }

  function medal(pos) {
    if (pos === 0) return "ðŸ¥‡";
    if (pos === 1) return "ðŸ¥ˆ";
    if (pos === 2) return "ðŸ¥‰";
    return "";
  }

  return (
    <div className="max-w-6xl mx-auto p-4 bg-gray-50 min-h-screen">
      <header className="mb-6">
        <div className="rounded-2xl p-4 bg-white shadow-sm border text-center">
          <div className="inline-block px-6 py-2 rounded-lg bg-gradient-to-r from-indigo-100 to-purple-100 text-indigo-800 font-extrabold tracking-wider text-2xl">IBTIDAIYA</div>
        </div>
      </header>

      <div className="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div className="inline-flex rounded-lg bg-white shadow-sm p-1">
          <button onClick={() => setView("Asatiza")} className={`px-4 py-2 rounded-lg text-sm font-medium transition ${view === "Asatiza" ? 'bg-teal-600 text-white shadow' : 'text-gray-700 hover:bg-gray-50'}`}>
            Asatiza
          </button>
          <button onClick={() => setView("Jamia")} className={`px-4 py-2 rounded-lg text-sm font-medium transition ${view === "Jamia" ? 'bg-indigo-600 text-white shadow' : 'text-gray-700 hover:bg-gray-50'}`}>
            Jamia
          </button>
        </div>
        <div className="text-sm text-gray-600">Auto-refresh: every {REFRESH_INTERVAL_MS / 1000}s â€¢ Last: {lastUpdated ? lastUpdated.toLocaleString() : 'â€”'}</div>
      </div>

      {view === "Asatiza" ? (
        <section>
          <div className="hidden md:block bg-white shadow rounded p-4">
            <table className="min-w-full table-auto border-collapse">
              <thead className="bg-white sticky top-0">
                <tr className="text-left border-b">
                  <th className="py-3 px-4 text-sm font-medium">Rank</th>
                  <th className="py-3 px-4 text-sm font-medium">Ustaz Name</th>
                  <th className="py-3 px-4 text-sm font-medium">Jamia Name</th>
                  <th className="py-3 px-4 text-sm font-medium text-right">Raqam</th>
                  <th className="py-3 px-4 text-sm font-medium text-right">Unit</th>
                </tr>
              </thead>
              <tbody>
                {asatizaData.map((r, idx) => {
                  const pos = getAsatizaPosition(r.id);
                  const tc = topClass(pos);
                  const raqamColor = pos === 0 ? 'text-emerald-600 font-bold' : pos === 1 ? 'text-sky-600 font-bold' : pos === 2 ? 'text-amber-600 font-bold' : 'text-slate-700';
                  return (
                    <tr key={r.id} className={`${tc} border mb-0 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                      <td className="py-4 px-4 text-sm align-top font-semibold">{pos !== null ? `${pos + 1}` : r.rank || 'â€”'}</td>
                      <td className="py-4 px-4 text-sm align-top">{r.ustaz || 'â€”'}</td>
                      <td className="py-4 px-4 text-sm align-top flex items-center gap-3">{pos !== null && <span className="text-xl">{medal(pos)}</span>}<span className="font-bold uppercase tracking-wide">{r.jamia || 'â€”'}</span></td>
                      <td className={`py-4 px-4 text-sm text-right align-top ${raqamColor}`}>{formatNumber(r.raqam)}</td>
                      <td className="py-4 px-4 text-sm text-right align-top"><span className="text-indigo-600 font-medium">{Number.isFinite(r.unit) ? r.unit.toFixed(1) : '0.0'}</span></td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          <div className="md:hidden flex flex-col gap-3">
            {asatizaData.map((r, idx) => {
              const pos = getAsatizaPosition(r.id);
              const tc = topClass(pos);
              const raqamColor = pos === 0 ? 'text-emerald-600 font-bold' : pos === 1 ? 'text-sky-600 font-bold' : pos === 2 ? 'text-amber-600 font-bold' : 'text-slate-700';
              return (
                <div key={r.id} className={`p-3 rounded-lg shadow-sm bg-white border ${tc}`}>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      {pos !== null && <div className="text-2xl">{medal(pos)}</div>}
                      <div>
                        <div className="text-sm text-gray-500">{r.rank || 'â€”'}</div>
                        <div className="font-semibold text-base">{r.ustaz || 'â€”'}</div>
                        <div className="text-xs text-gray-500">{r.jamia || 'â€”'}</div>
                      </div>
                    </div>
                    <div className="text-right">
                      <div className={`${raqamColor} text-lg`}>{formatNumber(r.raqam)}</div>
                      <div className="text-indigo-600 text-sm">{Number.isFinite(r.unit) ? r.unit.toFixed(1) : '0.0'}</div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </section>
      ) : (
        <section className="bg-white shadow rounded p-4">
          <div className="mb-4 flex items-center justify-between">
            <h2 className="text-lg font-semibold">Jamia â€” Aggregate</h2>
            <div className="text-sm text-gray-500">Top 3 highlighted</div>
          </div>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <ol className="list-decimal pl-6">
                {jamiaData.slice(0, 3).map((j, i) => (
                  <li key={j.id} className={`mb-2 p-3 border rounded ${i === 0 ? 'bg-amber-50 border-amber-300' : i === 1 ? 'bg-slate-50 border-slate-300' : 'bg-lime-50 border-lime-300'}`}>
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3"><div className="text-base font-semibold">{i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'} {j.jamia}</div><div className="text-sm text-gray-600">(#{i + 1})</div></div>
                      <div className="text-sm text-gray-700">Units: <span className="font-medium">{j.totalUnit.toFixed(2)}</span></div>
                    </div>
                    <div className="text-sm text-gray-600 mt-1">Total: <span className="font-semibold">{formatNumber(j.totalAmount)}</span></div>
                  </li>
                ))}
              </ol>
            </div>
            <div>
              <div className="overflow-x-auto">
                <table className="min-w-full table-auto border-collapse">
                  <thead className="bg-white sticky top-0">
                    <tr className="text-left border-b">
                      <th className="py-3 px-4 text-sm font-medium">Pos</th>
                      <th className="py-3 px-4 text-sm font-medium">Jamia</th>
                      <th className="py-3 px-4 text-sm font-medium text-right">Total Amount</th>
                      <th className="py-3 px-4 text-sm font-medium text-right">Total Units</th>
                    </tr>
                  </thead>
                  <tbody>
                    {jamiaData.map((j, i) => (
                      <tr key={j.id} className={`${i < 3 ? 'font-semibold' : ''} border-b`}>
                        <td className="py-3 px-4 text-sm align-top">{i < 3 ? (i === 0 ? 'ðŸ¥‡ 1' : i === 1 ? 'ðŸ¥ˆ 2' : 'ðŸ¥‰ 3') : (i + 1)}</td>
                        <td className={`py-3 px-4 text-sm align-top ${i === 0 ? 'text-amber-800' : i === 1 ? 'text-slate-800' : i === 2 ? 'text-lime-800' : ''}`}>{j.jamia}</td>
                        <td className="py-3 px-4 text-sm text-right align-top">{formatNumber(j.totalAmount)}</td>
                        <td className="py-3 px-4 text-sm text-right align-top">{j.totalUnit.toFixed(2)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      )}

      <footer className="mt-6 text-xs text-gray-500">Save this component and build a small React app or export to an HTML single-file if you want to deploy to GitHub Pages.</footer>
    </div>
  );
}
